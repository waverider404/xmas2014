!function(a,b){"use strict";b.CharacterController=function(b,c){a.EventDispatcher.prototype.apply(this),this.object=b,this.center=this.object.position.clone(),this.radius=c,this.groundPadding=.5,this.maxSlopeGradient=Math.cos(a.Math.degToRad(50)),this.isGrounded=!1,this.isOnSlope=!1,this.isIdling=!1,this.isRunning=!1,this.isJumping=!1,this.direction=0,this.movementSpeed=10,this.velocity=new a.Vector3(0,-10,0),this.currentJumpPower=0,this.jumpStartTime=0,this.groundHeight=0,this.groundNormal=new a.Vector3,this.collisionCandidate,this.contactInfo=[]},b.CharacterController.prototype={constructor:b.CharacterController,update:function(a){this.isGrounded=!1,this.isOnSlope=!1,this.groundHeight=-1/0,this.groundNormal.set(0,1,0),this.updateGrounding(),this.updateJumping(),this.updatePosition(a),this.collisionDetection(),this.solvePosition(),this.updateVelocity(),this.events()},updateVelocity:function(){var b,c,d,e,f,g,h,i,j=-20,k=-Math.cos(this.direction),l=-Math.sin(this.direction),m=!1;if(this.velocity.set(l*this.movementSpeed*this.isRunning,j,k*this.movementSpeed*this.isRunning),0!==this.contactInfo.length||this.isJumping){if(!this.isGrounded||this.isOnSlope||this.isJumping)if(this.isOnSlope){var n=j,o=-n/(1-this.groundNormal.y)*.2;this.velocity.x=this.groundNormal.x*o,this.velocity.y=j,this.velocity.z=this.groundNormal.z*o}else this.isGrounded||this.isOnSlope||!this.isJumping||(this.velocity.y=this.currentJumpPower*-j);else this.velocity.y=0;for(d=new a.Vector2(l,k),f=Math.atan2(d.y,d.x),g=Math.atan2(-d.y,-d.x),h=0,i=this.contactInfo.length;i>h;h++)b=this.contactInfo[h].face.normal,this.maxSlopeGradient<b.y||this.isOnSlope||(!m&&b.y<0&&(m=!0),c=new a.Vector2(b.x,b.z).normalize(),e=Math.atan2(c.y,c.x),Math.abs(g-e)>=.5*Math.PI&&Math.abs(g-e)<=1.5*Math.PI||(c.set(d.dot(c)*c.x,d.dot(c)*c.y),d.subVectors(d,c),this.velocity.x=d.x*this.movementSpeed*this.isRunning,this.velocity.z=d.y*this.movementSpeed*this.isRunning));m&&(this.velocity.y=Math.min(0,this.velocity.y),this.isJumping=!1)}},updateGrounding:function(){var c,d,e,f,g=this.collisionCandidate,h=new a.Vector3(this.center.x,this.center.y+this.radius,this.center.z),i=new a.Vector3(this.center.x,this.center.y-1e10,this.center.z);for(c=0,d=g.length;d>c;c++)f=b.collision.testSegmentTriangle(h,i,g[c].a,g[c].b,g[c].c),f&&!e?(e=f,e.face=g[c]):f&&f.contactPoint.y>e.contactPoint.y&&(e=f,e.face=g[c]);if(e){this.groundHeight=e.contactPoint.y,this.groundNormal.copy(e.face.normal);var j=h.y,k=this.center.y-this.radius-this.groundPadding;if(this.isJumping&&0<this.currentJumpPower)return this.isOnSlope=!1,void(this.isGrounded=!1);this.isGrounded=k<=this.groundHeight&&this.groundHeight<=j,this.isOnSlope=this.groundNormal.y<=this.maxSlopeGradient,this.isGrounded&&(this.isJumping=!1)}},updatePosition:function(a){var b=this.center.x+this.velocity.x*a,c=this.center.y+this.velocity.y*a,d=this.center.z+this.velocity.z*a;this.isGrounded&&(c=this.groundHeight+this.radius),this.center.set(b,c,d)},collisionDetection:function(){var a,c,d,e=this.collisionCandidate;for(this.contactInfo.length=0,a=0,c=e.length;c>a;a++)d=b.collision.isIntersectionSphereTriangle(this,e[a].a,e[a].b,e[a].c,e[a].normal),d&&(d.face=e[a],this.contactInfo.push(d))},solvePosition:function(){var b,c,d,e,f,g,h,i=new a.Vector3,j=new a.Vector3,k=new a.Vector3,l=new a.Vector3,m=new a.Vector3;if(0===this.contactInfo.length)return void this.object.position.copy(this.center);for(g=0,h=this.contactInfo.length;h>g;g++)if(b=this.contactInfo[g].face,c=this.contactInfo[g].face.normal,d=this.contactInfo[g].distance,!(this.maxSlopeGradient<c.y)){var n=this.maxSlopeGradient<=b.normal.y&&b.normal.y<1;this.isJumping&&0>=this.currentJumpPower&&n&&(this.isJumping=!1,this.isGrounded=!0),(this.isGrounded||this.isOnSlope)&&(i.copy(c).multiplyScalar(-this.radius).add(this.center),k.set(c.x,0,c.z).normalize(),e=b.a.dot(c),f=(e-(c.x*i.x+c.y*i.y+c.z*i.z))/(c.x*k.x+c.y*k.y+c.z*k.z),j.copy(k).multiplyScalar(f).add(i),l.subVectors(j,i),Math.abs(m.x)>Math.abs(l.x)&&(m.x+=l.x),Math.abs(m.z)>Math.abs(l.z)&&(m.z+=l.z))}this.center.add(m),this.object.position.copy(this.center)},events:function(){var a,b,c,d,e,f=!0;return function(){return f?(f=!1,a=this.isGrounded,b=this.isOnSlope,c=this.isIdling,d=this.isRunning,void(e=this.isJumping)):(d||this.isRunning||!this.isGrounded||this.isIdling?!d&&this.isRunning&&!this.isJumping&&this.isGrounded||!a&&this.isGrounded&&this.isRunning||b&&!this.isOnSlope&&this.isRunning&&this.isGrounded?(this.isIdling=!1,this.dispatchEvent({type:"startWalking"})):!e&&this.isJumping?(this.isIdling=!1,this.dispatchEvent({type:"startJumping"})):!b&&this.isOnSlope?this.dispatchEvent({type:"startSliding"}):!a||this.isGrounded||this.isJumping||this.dispatchEvent({type:"startFalling"}):(this.isIdling=!0,this.dispatchEvent({type:"startIdling"})),!a&&this.isGrounded,a=this.isGrounded,b=this.isOnSlope,c=this.isIdling,d=this.isRunning,void(e=this.isJumping))}}(),setDirection:function(){},jump:function(){this.isJumping||!this.isGrounded||this.isOnSlope||(this.jumpStartTime=Date.now(),this.currentJumpPower=1,this.isJumping=!0)},updateJumping:function(){var a=1e3;if(this.isJumping){var b=Date.now()-this.jumpStartTime,c=b/a;this.currentJumpPower=Math.cos(Math.min(c,1)*Math.PI)}}}}(THREE,GUSOKU),GUSOKU.AnimationController=function(a){this.mesh=a,this.motion={};var b,c,d;for(b=0,c=this.mesh.geometry.animations.length;c>b;b++)d=this.mesh.geometry.animations[b],this.motion[d.name]={anim:new THREE.Animation(a,d,THREE.AnimationHandler.CATMULLROM),duration:1e3*d.length}},GUSOKU.AnimationController.prototype.play=function(a){var b;for(b in this.motion)this.motion[b].anim.stop();this.motion[a].anim.play()},function(a,b){"use strict";function c(a){if(!this.isDisabled){switch(a.keyCode){case e:case f:this.isUp=!0;break;case g:case h:this.isDown=!0;break;case i:case j:this.isLeft=!0;break;case k:case l:this.isRight=!0;break;case m:this.jump()}this.updateAngle(),this.dispatchEvent({type:"movekeychange"}),(this.isUp||this.isDown||this.isLeft||this.isRight)&&(this.isMoveKeyHolded=!0,this.dispatchEvent({type:"movekeyhold"}))}}function d(a){if(!this.isDisabled){switch(a.keyCode){case e:case f:this.isUp=!1;break;case g:case h:this.isDown=!1;break;case i:case j:this.isLeft=!1;break;case k:case l:this.isRight=!1;break;case m:}this.updateAngle(),this.dispatchEvent({type:"movekeychange"}),this.isUp||this.isDown||this.isLeft||this.isRight||a.keyCode!==e&&a.keyCode!==f&&a.keyCode!==g&&a.keyCode!==h&&a.keyCode!==i&&a.keyCode!==j&&a.keyCode!==k&&a.keyCode!==l||this.dispatchEvent({type:"movekeyrelease"})}}var e=87,f=38,g=83,h=40,i=65,j=37,k=68,l=39,m=32,n=a.Math.degToRad(0),o=a.Math.degToRad(45),p=a.Math.degToRad(90),q=a.Math.degToRad(135),r=a.Math.degToRad(180),s=a.Math.degToRad(225),t=a.Math.degToRad(270),u=a.Math.degToRad(315),v=a.Math.degToRad(360);b.KeyInputControl=function(){a.EventDispatcher.prototype.apply(this),this.mouseAccelarationX=100,this.mouseAccelarationY=20,this.isDisabled=!1,this.isUp=!1,this.isDown=!1,this.isLeft=!1,this.isRight=!1,this.frontAngle=0,this._mousedownListener=c.bind(this),this._mouseupListener=d.bind(this),window.addEventListener("keydown",this._mousedownListener,!1),window.addEventListener("keyup",this._mouseupListener,!1)},b.KeyInputControl.prototype.jump=function(){this.dispatchEvent({type:"jumpkeypress"})},b.KeyInputControl.prototype.updateAngle=function(){var a=this.isUp,b=this.isDown,c=this.isLeft,d=this.isRight;!a||c||b||d?a&&c&&!b&&!d?this.frontAngle=o:a||!c||b||d?!a&&c&&b&&!d?this.frontAngle=q:a||c||!b||d?!a&&!c&&b&&d?this.frontAngle=s:a||c||b||!d?a&&!c&&!b&&d&&(this.frontAngle=u):this.frontAngle=t:this.frontAngle=r:this.frontAngle=p:this.frontAngle=n,this.frontAngle=this.frontAngle%v},b.KeyInputControl.prototype.getFrontAngle=function(){return this.frontAngle}}(THREE,GUSOKU),function(a,b){"use strict";function c(a){this.dispatchEvent({type:"mousedown"}),this._pointerStart.x=a.clientX,this._pointerStart.y=a.clientY,this._pointerLast.x=this.lon,this._pointerLast.y=this.lat,this.el.removeEventListener("mousemove",this._mousedragListener,!1),this.el.addEventListener("mousemove",this._mousedragListener,!1)}function d(){this.dispatchEvent({type:"mouseup"}),this.el.removeEventListener("mousemove",this._mousedragListener,!1)}function e(a){var b=this.el.offsetWidth,c=this.el.offsetHeight,d=(this._pointerStart.x-a.clientX)/b*2,e=(this._pointerStart.y-a.clientY)/c*2;this.setLatLon(this._pointerLast.y+e*this.mouseAccelerationY,this._pointerLast.x+d*this.mouseAccelerationX)}function f(a){a.preventDefault(),a.wheelDeltaY?this.radius-=.05*a.wheelDeltaY/5:a.wheelDelta?this.radius-=.05*a.wheelDelta/5:a.detail&&(this.radius+=a.detail/5),this.radius=Math.max(this.radius,this.minRadius),this.radius=Math.min(this.radius,this.maxRadius)}var g=2*Math.PI,h=Math.PI/2;b.TPSCameraControl=function(b,g,h){a.EventDispatcher.prototype.apply(this),this.camera=b,this.trackObject=g,this.el=h&&h.el||window,this.offset=h&&h.offset||new a.Vector3(0,0,0),this.radius=h&&h.radius||10,this.minRadius=h&&h.minRadius||1,this.maxRadius=h&&h.maxRadius||30,this.rigidObjects=h&&h.rigidObjects||[],this.lat=0,this.lon=0,this.phi=0,this.theta=0,this.mouseAccelerationX=h&&void 0!==h.mouseAccelerationX?h.mouseAccelerationX:100,this.mouseAccelerationY=h&&void 0!==h.mouseAccelerationY?h.mouseAccelerationY:30,this._pointerStart={x:0,y:0},this._pointerLast={x:0,y:0},this.setNearPlainCornersWithPadding(),this.update(),this._mousedownListener=c.bind(this),this._mouseupListener=d.bind(this),this._mousedragListener=e.bind(this),this._scrollListener=f.bind(this),this.el.addEventListener("mousedown",this._mousedownListener,!1),this.el.addEventListener("mouseup",this._mouseupListener,!1),this.el.addEventListener("mousewheel",this._scrollListener,!1),this.el.addEventListener("DOMMouseScroll",this._scrollListener,!1)},b.TPSCameraControl.prototype={constructor:b.TPSCameraControl,update:function(){var b,c;this._center=new a.Vector3(this.trackObject.matrixWorld.elements[12]+this.offset.x,this.trackObject.matrixWorld.elements[13]+this.offset.y,this.trackObject.matrixWorld.elements[14]+this.offset.z),b=new a.Vector3(Math.cos(this.phi)*Math.cos(this.theta+h),Math.sin(this.phi),Math.cos(this.phi)*Math.sin(this.theta+h)),c=this.collisionTest(b.clone().normalize()),b.multiplyScalar(c),b.add(this._center),this.camera.position.copy(b),90===this.lat?this.camera.up.set(Math.cos(this.theta+Math.PI),0,Math.sin(this.theta+Math.PI)):-90===this.lat?this.camera.up.set(Math.cos(this.theta),0,Math.sin(this.theta)):this.camera.up.set(0,1,0),this.camera.lookAt(this._center),this.dispatchEvent({type:"updated"})},getFrontAngle:function(){return g+this.theta},setNearPlainCornersWithPadding:function(){var b=this.camera.near,c=.5*this.camera.fov,d=Math.tan(a.Math.degToRad(c))*b,e=d*this.camera.aspect;this.nearPlainCornersWithPadding=[new a.Vector3(-e-b,-d-b,0),new a.Vector3(e+b,-d-b,0),new a.Vector3(e+b,d+b,0),new a.Vector3(-e-b,d+b,0)]},setLatLon:function(b,c){this.lat=b>90?90:-90>b?-90:b,this.lon=0>c?360+c%360:c%360,this.phi=a.Math.degToRad(this.lat),this.theta=-a.Math.degToRad(this.lon)},collisionTest:function(b){var c,d,e,f,g,h=this.radius,i=new a.Matrix4,j=(new a.Matrix4).makeRotationX(this.phi),k=(new a.Matrix4).makeRotationY(this.theta);for(i.multiplyMatrices(j,k),c=0;4>c;c++)d=this.nearPlainCornersWithPadding[c].clone(),d.applyMatrix4(i),e=new a.Vector3(this._center.x+d.x,this._center.y+d.y,this._center.z+d.z),f=new a.Raycaster(e,b,this.camera.near,this.radius),g=f.intersectObjects(this.rigidObjects),0!==g.length&&g[0].distance<h&&(h=g[0].distance);return h}}}(THREE,GUSOKU);